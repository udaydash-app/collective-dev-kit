// This file is automatically generated. Do not edit it directly.
import { createClient, SupabaseClient } from '@supabase/supabase-js';
import type { Database } from './types';

const CLOUD_SUPABASE_URL = "https://wvdrsofehwiopbkzrqit.supabase.co";
const CLOUD_SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind2ZHJzb2ZlaHdpb3Bia3pycWl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NzE1NjUsImV4cCI6MjA3NjA0NzU2NX0.GH5r-1xInHsL_EyzMOTVtb2QWIImuyJe-_ysqF0LCQ0";

// Check for local Supabase configuration (set via Settings page or localStorage)
// SECURITY: Only anon key is supported for client-side use. Service role keys must never be stored client-side.
export const getSupabaseConfig = () => {
  try {
    const localConfig = localStorage.getItem('local_supabase_config');
    if (localConfig) {
      const config = JSON.parse(localConfig);
      // SECURITY: Only use anonKey, never store or use service_role keys on client
      if (config.url && config.anonKey) {
        console.log('[Supabase] Using local configuration:', config.url);
        return { url: config.url, key: config.anonKey, isLocal: true };
      }
    }
  } catch (error) {
    console.error('[Supabase] Error reading local config:', error);
  }
  return { url: CLOUD_SUPABASE_URL, key: CLOUD_SUPABASE_KEY, isLocal: false };
};

// Create supabase client - reads config at initialization
const createSupabaseClient = (): SupabaseClient<Database> => {
  const config = getSupabaseConfig();
  
  return createClient<Database>(config.url, config.key, {
    auth: {
      storage: localStorage,
      persistSession: true,
      autoRefreshToken: true,
    }
  });
};

// The supabase client instance
export const supabase = createSupabaseClient();

// Helper to update local Supabase config (call this from Settings)
// SECURITY: Only accepts anonKey, service role keys are rejected for security
export const setLocalSupabaseConfig = (url: string, anonKey: string) => {
  // Validate that we're not accidentally storing a service_role key
  // Service role JWTs contain "role":"service_role" in their payload
  try {
    const parts = anonKey.split('.');
    if (parts.length === 3) {
      const payload = JSON.parse(atob(parts[1]));
      if (payload.role === 'service_role') {
        console.error('[Supabase] Security Error: Service role keys cannot be stored client-side');
        throw new Error('Service role keys are not allowed in client-side configuration for security reasons. Please use the anon key instead.');
      }
    }
  } catch (parseError) {
    // If we can't parse the JWT, that's fine - just store it
    // The validation is a best-effort security check
  }
  
  console.log('[Supabase] Setting local config:', url);
  localStorage.setItem('local_supabase_config', JSON.stringify({ url, anonKey }));
  // Reload to apply new config
  window.location.reload();
};

export const clearLocalSupabaseConfig = () => {
  console.log('[Supabase] Clearing local config');
  localStorage.removeItem('local_supabase_config');
  window.location.reload();
};

export const getLocalSupabaseConfigStatus = () => {
  try {
    const localConfig = localStorage.getItem('local_supabase_config');
    if (localConfig) {
      const config = JSON.parse(localConfig);
      // Return only safe info, never expose keys
      return { url: config.url, hasConfig: true };
    }
  } catch (error) {
    console.error('Error reading local config:', error);
  }
  return null;
};

// Check if currently using local Supabase
export const isUsingLocalSupabase = (): boolean => {
  return getSupabaseConfig().isLocal;
};
